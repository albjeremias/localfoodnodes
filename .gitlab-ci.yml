variables:
  TARGET_DIR: /var/www

# Server need composer, npm and sshpass

deploy_staging:
  stage: deploy
  tags:
    - staging
  script:

    # Build Vue components
    # - rm package-lock.json
    - npm install
    - npm run production

    # Build React components
    # - rm resources/assets/js/react/node-map/package-lock.json
    - npm install --prefix resources/assets/js/react/node-map
    - npm run build --prefix resources/assets/js/react/node-map

    # - rm resources/assets/js/react/producer-node-map/package-lock.json
    - npm install --prefix resources/assets/js/react/producer-node-map
    - npm run build --prefix resources/assets/js/react/producer-node-map

    # Build Laravel
    # - rm composer-lock.json
    - composer install
    - sudo mkdir -p $TARGET_DIR/$CI_PROJECT_NAME
    - rsync -avzr $CI_PROJECT_DIR $TARGET_DIR
    - sudo chmod 777 -R $TARGET_DIR/$CI_PROJECT_NAME/storage
    - artisan migrate
  only:
    - master